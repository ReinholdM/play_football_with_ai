'''
usage: replace filename with the dump file generated by play_game script.
'''

from types import TracebackType
import six.moves.cPickle as Pickle
from gfootball.env.football_action_set import action_set_dict
from gfootball.env.wrappers import Simple115StateWrapper
import gfootball.env as football_env
import os
import json

env = football_env.create_environment(
    "malib_5_vs_5",
    representation='simple115v2',
    render=False
    )
# depends on the action set flag used in game_play command    
default_actions = action_set_dict['full']
Simple115StateWrapper = Simple115StateWrapper(env, True)

def process_single_dump(filename):
    traj = []
    with open(filename, 'rb') as f:
        while True:
            try:
                # step is a dict 
                step = Pickle.load(f)
                # the 0-th element in action list, it that human-controlled? 
                action = step['debug']['action'][0]
                observation = step['observation']
                action = default_actions.index(action)
                active = observation['left_agent_controlled_player']
                # controlled, designated, team_sticky_action are lack in original obs.So we need transform here.
                del observation['left_agent_controlled_player']
                # len(active) = 1
                observation['active'] = active[0]
                observation = Simple115StateWrapper.observation([observation])
                traj.append([observation.flatten(), action])
            except EOFError:
                return traj

def process_dumps_in_batch(path):
    trajs = []
    for f in os.listdir(path):
        traj =  process_single_dump(os.path.join(path,f))
        trajs.append(traj)
    return trajs

# for example, files dumped at /tmp/football
trajs = process_dumps_in_batch('/tmp/football')